import{j as e,h as J,b as H,B as A,a3 as K,a4 as Q,k as F}from"./index-BGj3ccG0.js";import{r as a}from"./recharts-D6sLb6Nn.js";import{C as W,a as X,b as Z,d as ee,c as se}from"./card-BiC0Y-bv.js";import{T as te,a as ae,b as R,c as D,e as re,d as M}from"./table-DvF6-9ey.js";import{B as ne}from"./badge-BzW7j6N6.js";import{D as z,a as O,b as V,c as Y,d as _}from"./dialog-8fFKTUy3.js";import{I as T}from"./input-YaoJJbld.js";import{L as y}from"./label-BzcwPuvC.js";import{S as E,a as $,b as k,c as P,d as U}from"./select-ORjsMoKt.js";import{c as ie,g as le,r as oe,m as ce,n as B,o as L,p as I}from"./firestore-CWn7XY5I.js";import{P as de,r as ue}from"./lucide-1LV0pfLj.js";import{A as he,a as me,b as xe,c as je,d as fe,e as pe,f as ge,g as Se,h as ve}from"./alert-dialog-DYLDXeiv.js";import"./firebase-DJ2aAbxa.js";const G=a.forwardRef(({className:r,...d},l)=>e.jsx("textarea",{className:J("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),ref:l,...d}));G.displayName="Textarea";function ye({onMovementRequested:r}){const{user:d}=H(),[l,f]=a.useState([]),[w,C]=a.useState([]),[u,b]=a.useState(""),[h,m]=a.useState(""),[x,p]=a.useState(""),[g,o]=a.useState(""),[S,v]=a.useState(!1),[q,s]=a.useState(null),[n,c]=a.useState(!1);a.useEffect(()=>{n&&(async()=>{try{const[i,N]=await Promise.all([ie(),le()]);f(i),C(N)}catch(i){s("Failed to load assets and sites."),console.error(i)}})()},[n]),a.useEffect(()=>{const t=l.find(i=>i.id===u);m(t?t.site:"")},[u,l]);const j=async t=>{if(t.preventDefault(),!d){s("You must be logged in to make a request.");return}s(null),v(!0);const i=l.find(N=>N.id===u);try{await oe({assetId:i?i.serialNumber:u,fromSite:h,toSite:x,reason:g,requestedBy:d.email||"Unknown User"}),r(),c(!1),b(""),m(""),p(""),o("")}catch(N){s("Failed to submit request. Please try again."),console.error(N)}finally{v(!1)}};return e.jsxs(z,{open:n,onOpenChange:c,children:[e.jsx(O,{asChild:!0,children:e.jsx(A,{children:"New Movement Request"})}),e.jsxs(V,{className:"sm:max-w-[425px]",children:[e.jsx(Y,{children:e.jsx(_,{children:"Request Asset Movement"})}),e.jsxs("form",{onSubmit:j,className:"space-y-4 py-4",children:[q&&e.jsx("p",{className:"text-destructive",children:q}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"Asset"}),e.jsxs(E,{onValueChange:b,value:u,required:!0,children:[e.jsx($,{children:e.jsx(k,{placeholder:"Select Asset"})}),e.jsx(P,{children:l.map(t=>e.jsxs(U,{value:t.id,children:[t.serialNumber," (",t.type,")"]},t.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"fromSite",children:"From Site"}),e.jsx(T,{id:"fromSite",value:h,disabled:!0,placeholder:"Automatically assigned"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{children:"To Site"}),e.jsxs(E,{onValueChange:p,value:x,required:!0,children:[e.jsx($,{children:e.jsx(k,{placeholder:"Select Destination Site"})}),e.jsx(P,{children:w.filter(t=>t.name!==h).map(t=>e.jsx(U,{value:t.name,children:t.name},t.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"reason",children:"Reason"}),e.jsx(G,{id:"reason",placeholder:"Reason for movement (optional)",value:g,onChange:t=>o(t.target.value)})]}),e.jsx(A,{type:"submit",className:"w-full",disabled:S,children:S?"Submitting...":"Submit Request"})]})]})]})}function be({movement:r,onMovementUpdated:d}){const[l,f]=a.useState(r.assetId),[w,C]=a.useState(r.fromSite),[u,b]=a.useState(r.toSite),[h,m]=a.useState(r.reason||""),[x,p]=a.useState(!1),[g,o]=a.useState(null),[S,v]=a.useState(!1);a.useEffect(()=>{S&&(f(r.assetId),C(r.fromSite),b(r.toSite),m(r.reason||""))},[S,r]);const q=async s=>{s.preventDefault(),o(null),p(!0);try{await ce(r.id,{assetId:l,fromSite:w,toSite:u,reason:h}),d(),v(!1)}catch(n){o("Failed to update asset movement. Please try again."),console.error(n)}finally{p(!1)}};return e.jsxs(z,{open:S,onOpenChange:v,children:[e.jsx(O,{asChild:!0,children:e.jsx(A,{variant:"ghost",size:"icon",children:e.jsx(de,{className:"h-4 w-4"})})}),e.jsxs(V,{className:"sm:max-w-[425px]",children:[e.jsx(Y,{children:e.jsx(_,{children:"Edit Asset Movement"})}),e.jsxs("form",{onSubmit:q,className:"grid gap-4 py-4",children:[g&&e.jsx("p",{className:"text-destructive",children:g}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"assetId",children:"Asset ID"}),e.jsx(T,{id:"assetId",value:l,onChange:s=>f(s.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"fromSite",children:"From Site"}),e.jsx(T,{id:"fromSite",value:w,onChange:s=>C(s.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"toSite",children:"To Site"}),e.jsx(T,{id:"toSite",value:u,onChange:s=>b(s.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{htmlFor:"reason",children:"Reason"}),e.jsx(T,{id:"reason",value:h,onChange:s=>m(s.target.value)})]}),e.jsx(A,{type:"submit",disabled:x,children:x?"Updating Movement...":"Update Movement"})]})]})]})}const Ne={Pending:"default",Approved:"success",Rejected:"destructive"};function Pe(){const{user:r,role:d}=H(),{addNotification:l,refreshNotifications:f}=K(),w=d==="admin"||d==="operations_manager",C=d==="admin",[u,b]=a.useState([]),[h,m]=a.useState(!0),[x,p]=a.useState(null),g=Q(),o=async()=>{try{m(!0);const s=await B();b(s),p(null)}catch(s){p("Failed to fetch movement requests. Please try again later."),console.error(s)}finally{m(!1)}};a.useEffect(()=>{o()},[]);const S=async()=>{await o();const s=await L("admin"),n=await L("operations_manager");[...s,...n].forEach(async j=>{const t=(await B()).sort((i,N)=>N.id>i.id?1:-1)[0];if(t){const i=await I(t.assetId);l(`New asset movement request for ${(i==null?void 0:i.serialNumber)||t.assetId} from ${t.fromSite} to ${t.toSite}.`,"info",`/asset-movement-requests/${t.id}`,j.uid)}}),f()},v=async(s,n)=>{const c=F(g,"updateMovementStatus");try{await c({movementId:s.id,status:n}),o();const j=await I(s.assetId);l(`Your asset movement request for ${(j==null?void 0:j.serialNumber)||s.assetId} to ${s.toSite} has been ${n.toLowerCase()}.`,n==="Approved"?"success":"error",`/asset-movement-requests/${s.id}`,s.requestedBy),f()}catch(j){alert(`Failed to ${n.toLowerCase()} request. Please try again.`),console.error("Error calling updateMovementStatus: ",j)}},q=async s=>{const n=F(g,"deleteMovementRequest");try{await n({movementId:s.id}),o();const c=await I(s.assetId);l(`Your asset movement request for ${(c==null?void 0:c.serialNumber)||s.assetId} from ${s.fromSite} to ${s.toSite} was deleted by an administrator.`,"error",void 0,s.requestedBy),f()}catch(c){console.error("Error deleting asset movement: ",c),alert("Failed to delete the request. Please try again.")}};return e.jsxs("div",{className:"flex-1 space-y-4 p-4 md:p-8 pt-6",children:[e.jsxs("div",{className:"flex items-center justify-between space-y-2",children:[e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:"Asset Movements"}),e.jsx(ye,{onMovementRequested:S})]}),e.jsxs(W,{children:[e.jsxs(X,{children:[e.jsx(Z,{children:"Movement Requests"}),e.jsx(ee,{children:"Track the status of all asset transfer requests."})]}),e.jsxs(se,{children:[h&&e.jsx("p",{children:"Loading requests..."}),x&&e.jsx("p",{className:"text-destructive",children:x}),!h&&!x&&e.jsxs(te,{children:[e.jsx(ae,{children:e.jsxs(R,{children:[e.jsx(D,{children:"Asset Serial"}),e.jsx(D,{children:"From"}),e.jsx(D,{children:"To"}),e.jsx(D,{children:"Reason"}),e.jsx(D,{children:"Status"}),e.jsx(D,{className:"text-right",children:"Actions"})]})}),e.jsx(re,{children:u.map(s=>e.jsxs(R,{children:[e.jsx(M,{className:"font-medium",children:s.assetId}),e.jsx(M,{children:s.fromSite}),e.jsx(M,{children:s.toSite}),e.jsx(M,{children:s.reason}),e.jsx(M,{children:e.jsx(ne,{variant:Ne[s.status]||"default",children:s.status})}),e.jsx(M,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end items-center",children:[w&&s.status==="Pending"&&e.jsxs("div",{className:"space-x-2",children:[e.jsx(A,{variant:"destructive",size:"sm",onClick:()=>v(s,"Rejected"),children:"Reject"}),e.jsx(A,{size:"sm",className:"bg-green-500 hover:bg-green-600",onClick:()=>v(s,"Approved"),children:"Approve"})]}),e.jsx(be,{movement:s,onMovementUpdated:o}),C&&e.jsxs(he,{children:[e.jsx(me,{asChild:!0,children:e.jsx(A,{variant:"ghost",size:"icon",children:e.jsx(ue,{className:"h-4 w-4"})})}),e.jsxs(xe,{children:[e.jsxs(je,{children:[e.jsx(fe,{children:"Are you sure?"}),e.jsx(pe,{children:"This action cannot be undone. This will permanently delete the asset movement request."})]}),e.jsxs(ge,{children:[e.jsx(Se,{children:"Cancel"}),e.jsx(ve,{onClick:()=>q(s),children:"Delete"})]})]})]})]})})]},s.id))})]})]})]})]})}export{Pe as default};
