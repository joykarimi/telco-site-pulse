import{j as e}from"./index-BGj3ccG0.js";import{r as n}from"./recharts-D6sLb6Nn.js";import{C as j,a as S,b as C,d as y,c as b}from"./card-BiC0Y-bv.js";import{g as L,a as V}from"./firestore-CWn7XY5I.js";import{S as v,a as N,b as D,c as M,d as w}from"./select-ORjsMoKt.js";import"./lucide-1LV0pfLj.js";import"./firebase-DJ2aAbxa.js";const E=new Date().getFullYear(),I=Array.from({length:5},(o,r)=>E-r),U=Array.from({length:12},(o,r)=>({value:r+1,name:new Date(0,r).toLocaleString("default",{month:"long"})}));function z(){const[o,r]=n.useState([]),[P,f]=n.useState(!0),[h,p]=n.useState(null),[i,A]=n.useState(new Date().getMonth()+1),[l,Y]=n.useState(E);n.useEffect(()=>{(async()=>{try{f(!0);const[s,c]=await Promise.all([L(),V(i,l)]),F=new Map(c.map(d=>[d.siteId,d])),J=s.map(d=>{const a=F.get(d.id);return{...d,monthlyData:a?{month:a.month,year:a.year,gridConsumption:a.gridConsumption,fuelConsumption:a.fuelConsumption,solarContribution:a.solarContribution,earningsSafaricom:a.earningsSafaricom,earningsAirtel:a.earningsAirtel,earningsJtl:a.earningsJtl,gridUnitCost:a.gridUnitCost,fuelUnitCost:a.fuelUnitCost,solarMaintenanceCost:a.solarMaintenanceCost}:null}});r(J),p(null)}catch(s){p("Failed to fetch site profitability data. Please try again later."),console.error(s)}finally{f(!1)}})()},[i,l]);const u=n.useMemo(()=>o?o.map(t=>{if(!t.monthlyData)return{name:t.name,profit:0};const s=t.monthlyData,c=(s.earningsSafaricom??0)+(s.earningsAirtel??0)+(s.earningsJtl??0)-(s.gridConsumption*s.gridUnitCost+s.fuelConsumption*s.fuelUnitCost+s.solarMaintenanceCost);return{name:t.name,profit:c}}).sort((t,s)=>s.profit-t.profit):[],[o]),x=u.filter(t=>t.profit>=0),g=u.filter(t=>t.profit<0),m=t=>{var s;return((s=U.find(c=>c.value===t))==null?void 0:s.name)||""};return e.jsxs("div",{className:"flex-1 space-y-4 p-4 md:p-8 pt-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between space-y-2 md:space-y-0",children:[e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:"Site Profitability"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(v,{value:String(i),onValueChange:t=>A(Number(t)),children:[e.jsx(N,{className:"w-[180px]",children:e.jsx(D,{placeholder:"Select Month"})}),e.jsx(M,{children:U.map(t=>e.jsx(w,{value:String(t.value),children:t.name},t.value))})]}),e.jsxs(v,{value:String(l),onValueChange:t=>Y(Number(t)),children:[e.jsx(N,{className:"w-[120px]",children:e.jsx(D,{placeholder:"Select Year"})}),e.jsx(M,{children:I.map(t=>e.jsx(w,{value:String(t),children:t},t))})]})]})]}),P?e.jsxs("p",{children:["Loading site profitability data for ",m(i)," ",l,"..."]}):h?e.jsx("p",{className:"text-destructive",children:h}):e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-2",children:[e.jsxs(j,{children:[e.jsxs(S,{children:[e.jsx(C,{children:"Profitable Sites"}),e.jsxs(y,{children:["Sites that generated a profit for ",m(i)," ",l,"."]})]}),e.jsx(b,{className:"space-y-4",children:x.length>0?x.map(t=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{children:t.name}),e.jsxs("div",{className:"ml-auto font-medium text-green-600",children:["KES ",t.profit.toFixed(2)]})]},t.name)):e.jsx("p",{children:"No profitable sites found for the selected period."})})]}),e.jsxs(j,{children:[e.jsxs(S,{children:[e.jsx(C,{children:"Unprofitable Sites"}),e.jsxs(y,{children:["Sites that incurred a loss for ",m(i)," ",l,"."]})]}),e.jsx(b,{className:"space-y-4",children:g.length>0?g.map(t=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{children:t.name}),e.jsxs("div",{className:"ml-auto font-medium text-red-600",children:["KES ",t.profit.toFixed(2)]})]},t.name)):e.jsx("p",{children:"No unprofitable sites found for the selected period."})})]})]})]})}export{z as default};
