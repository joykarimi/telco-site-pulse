import{j as e,h as S}from"./index-BGj3ccG0.js";import{r as v,T as q,L as G,e as $,P as W,i as z,g as O,B as D,C as Q,X as ee,Y as te,f as re}from"./recharts-D6sLb6Nn.js";import{g as se,a as ne}from"./firestore-CWn7XY5I.js";import{C as B,a as K,b as F,d as V,c as J}from"./card-BiC0Y-bv.js";import{A as ae,Z as le}from"./lucide-1LV0pfLj.js";import{S as k,a as L,b as T,c as A,d as w}from"./select-ORjsMoKt.js";import"./firebase-DJ2aAbxa.js";const oe={light:"",dark:".dark"},H=v.createContext(null);function U(){const n=v.useContext(H);if(!n)throw new Error("useChart must be used within a <ChartContainer />");return n}const P=v.forwardRef(({id:n,className:r,children:d,config:l,...o},g)=>{const t=v.useId(),s=`chart-${n||t.replace(/:/g,"")}`;return e.jsx(H.Provider,{value:{config:l},children:e.jsxs("div",{"data-chart":s,ref:g,className:S("flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none",r),...o,children:[e.jsx(ce,{id:s,config:l}),e.jsx($,{children:d})]})})});P.displayName="Chart";const ce=({id:n,config:r})=>{const d=Object.entries(r).filter(([l,o])=>o.theme||o.color);return d.length?e.jsx("style",{dangerouslySetInnerHTML:{__html:Object.entries(oe).map(([l,o])=>`
${o} [data-chart=${n}] {
${d.map(([g,t])=>{var h;const s=((h=t.theme)==null?void 0:h[l])||t.color;return s?`  --color-${g}: ${s};`:null}).join(`
`)}
}
`).join(`
`)}}):null},M=q,R=v.forwardRef(({active:n,payload:r,className:d,indicator:l="dot",hideLabel:o=!1,hideIndicator:g=!1,label:t,labelFormatter:s,labelClassName:h,formatter:c,color:j,nameKey:p,labelKey:m},y)=>{const{config:u}=U(),f=v.useMemo(()=>{var N;if(o||!(r!=null&&r.length))return null;const[i]=r,_=`${m||i.dataKey||i.name||"value"}`,b=E(u,i,_),a=!m&&typeof t=="string"?((N=u[t])==null?void 0:N.label)||t:b==null?void 0:b.label;return s?e.jsx("div",{className:S("font-medium",h),children:s(a,r)}):a?e.jsx("div",{className:S("font-medium",h),children:a}):null},[t,s,r,o,h,u,m]);if(!n||!(r!=null&&r.length))return null;const x=r.length===1&&l!=="dot";return e.jsxs("div",{ref:y,className:S("grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl",d),children:[x?null:f,e.jsx("div",{className:"grid gap-1.5",children:r.map((i,_)=>{const b=`${p||i.name||i.dataKey||"value"}`,a=E(u,i,b),N=j||i.payload.fill||i.color;return e.jsx("div",{className:S("flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground",l==="dot"&&"items-center"),children:c&&(i==null?void 0:i.value)!==void 0&&i.name?c(i.value,i.name,i,_,i.payload):e.jsxs(e.Fragment,{children:[a!=null&&a.icon?e.jsx(a.icon,{}):!g&&e.jsx("div",{className:S("shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]",{"h-2.5 w-2.5":l==="dot","w-1":l==="line","w-0 border-[1.5px] border-dashed bg-transparent":l==="dashed","my-0.5":x&&l==="dashed"}),style:{"--color-bg":N,"--color-border":N}}),e.jsxs("div",{className:S("flex flex-1 justify-between leading-none",x?"items-end":"items-center"),children:[e.jsxs("div",{className:"grid gap-1.5",children:[x?f:null,e.jsx("span",{className:"text-muted-foreground",children:(a==null?void 0:a.label)||i.name})]}),i.value&&e.jsx("span",{className:"font-mono font-medium tabular-nums text-foreground",children:i.value.toLocaleString()})]})]})},i.dataKey)})})]})});R.displayName="ChartTooltip";const ie=G,X=v.forwardRef(({className:n,hideIcon:r=!1,payload:d,verticalAlign:l="bottom",nameKey:o},g)=>{const{config:t}=U();return d!=null&&d.length?e.jsx("div",{ref:g,className:S("flex items-center justify-center gap-4",l==="top"?"pb-3":"pt-3",n),children:d.map(s=>{const h=`${o||s.dataKey||"value"}`,c=E(t,s,h);return e.jsxs("div",{className:S("flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground"),children:[c!=null&&c.icon&&!r?e.jsx(c.icon,{}):e.jsx("div",{className:"h-2 w-2 shrink-0 rounded-[2px]",style:{backgroundColor:s.color}}),c==null?void 0:c.label]},s.value)})}):null});X.displayName="ChartLegend";function E(n,r,d){if(typeof r!="object"||r===null)return;const l="payload"in r&&typeof r.payload=="object"&&r.payload!==null?r.payload:void 0;let o=d;return d in r&&typeof r[d]=="string"?o=r[d]:l&&d in l&&typeof l[d]=="string"&&(o=l[d]),o in n?n[o]:n[d]}const C=n=>Number(n)||0,de=new Set(["grid-generator-solar","generator-solar","grid-solar"]);function ue(n){const r=C(n.safaricomIncome)+C(n.airtelIncome)+C(n.jtlIncome),l=Math.max(0,C(n.gridConsumption)-C(n.solarContribution))*C(n.gridCostPerKwh),o=C(n.fuelConsumption)*C(n.fuelCostPerLiter),g=de.has(n.type)?C(n.solarMaintenanceCost):0,t=l+o+g,s=r-t,h=r>0?s/r*100:0;return{totalRevenue:r,gridExpense:l,fuelExpense:o,solarExpense:g,totalExpense:t,netProfitLoss:s,profitMargin:h}}function I(n){return new Intl.NumberFormat("en-KE",{style:"currency",currency:"KES",minimumFractionDigits:0,maximumFractionDigits:0}).format(C(n))}const he=({cx:n,cy:r,midAngle:d,outerRadius:l,percent:o,name:g,value:t})=>{const s=Math.PI/180,h=Math.sin(-s*d),c=Math.cos(-s*d),j=n+l*c,p=r+l*h,m=n+(l+30)*c,y=r+(l+30)*h,u=m+(c>=0?1:-1)*22,f=y,x=c>=0?"start":"end";return e.jsxs("g",{children:[e.jsx("path",{d:`M${j},${p}L${m},${y}L${u},${f}`,stroke:"hsl(var(--muted-foreground))",fill:"none",strokeWidth:1}),e.jsx("circle",{cx:u,cy:f,r:2,fill:"hsl(var(--muted-foreground))",stroke:"none"}),e.jsx("text",{x:u+(c>=0?1:-1)*12,y:f,textAnchor:x,fill:"hsl(var(--foreground))",className:"text-xs font-semibold",children:`${g} ${(o*100).toFixed(1)}%`})]})};function me({sites:n}){const r=n.reduce((t,s)=>{const h=ue(s),c=s.safaricomIncome>0,j=s.airtelIncome>0,p=s.jtlIncome>0;let m="none";return[c,j,p].filter(Boolean).length===3?m="multi_vendor":c&&j&&!p?m="colocated":c&&p&&!j?m="safaricom_jtl_colocated":j&&p&&!c?m="airtel_jtl_colocated":c&&!j&&!p?m="safaricom_only":j&&!c&&!p?m="airtel_only":p&&!c&&!j&&(m="jtl_only"),m==="none"||(t[m]||(t[m]={count:0,revenue:0,profit:0}),t[m].count+=1,t[m].revenue+=h.totalRevenue,t[m].profit+=h.netProfitLoss),t},{}),d=Object.values(r).reduce((t,s)=>t+s.revenue,0),l=Object.entries(r).map(([t,s])=>({originalType:t,name:t==="colocated"?"Safaricom & Airtel":t==="safaricom_only"?"Safaricom Only":t==="airtel_only"?"Airtel Only":t==="jtl_only"?"JTL Only":t==="multi_vendor"?"Multi-Vendor":t==="safaricom_jtl_colocated"?"Safaricom & JTL":t==="airtel_jtl_colocated"?"Airtel & JTL":"Unknown",value:s.revenue,count:s.count,profit:s.profit,percentage:d?(s.revenue/d*100).toFixed(1):"0"})),o={safaricom_only:{light:"hsl(142, 70%, 50%)",dark:"hsl(142, 70%, 65%)"},airtel_only:{light:"hsl(210, 70%, 50%)",dark:"hsl(210, 70%, 65%)"},jtl_only:{light:"hsl(45, 70%, 50%)",dark:"hsl(45, 70%, 65%)"},colocated:{light:"hsl(270, 50%, 50%)",dark:"hsl(270, 50%, 65%)"},safaricom_jtl_colocated:{light:"hsl(100, 50%, 40%)",dark:"hsl(100, 50%, 55%)"},airtel_jtl_colocated:{light:"hsl(180, 50%, 40%)",dark:"hsl(180, 50%, 55%)"},multi_vendor:{light:"hsl(330, 60%, 50%)",dark:"hsl(330, 60%, 65%)"}},g={colocated:{label:"Safaricom & Airtel",theme:o.colocated},safaricom_only:{label:"Safaricom Only",theme:o.safaricom_only},airtel_only:{label:"Airtel Only",theme:o.airtel_only},jtl_only:{label:"JTL Only",theme:o.jtl_only},multi_vendor:{label:"Multi-Vendor",theme:o.multi_vendor},safaricom_jtl_colocated:{label:"Safaricom & JTL Colocated",theme:o.safaricom_jtl_colocated},airtel_jtl_colocated:{label:"Airtel & JTL Colocated",theme:o.airtel_jtl_colocated},revenue:{label:"Revenue",theme:{light:"hsl(217 91% 60%)",dark:"hsl(217 91% 70%)"}},profit:{label:"Profit",theme:{light:"hsl(142 76% 36%)",dark:"hsl(142 76% 56%)"}}};return e.jsxs("div",{className:"space-y-6 animate-fade-in",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(B,{className:"animate-slide-in-right bg-gradient-card hover:shadow-custom-hover transition-all duration-300",children:[e.jsxs(K,{children:[e.jsxs(F,{className:"flex items-center gap-2",children:[e.jsx(ae,{className:"h-5 w-5 text-primary animate-pulse"}),"Revenue Distribution"]}),e.jsx(V,{children:"Breakdown by site configuration"})]}),e.jsx(J,{className:"p-0 pb-4",children:e.jsx(P,{config:g,children:e.jsx($,{width:"100%",height:300,children:e.jsxs(W,{children:[e.jsx(M,{content:e.jsx(R,{formatter:(t,s)=>[I(t),s]})}),e.jsx(z,{data:l,cx:"50%",cy:"50%",innerRadius:60,outerRadius:100,paddingAngle:2,dataKey:"value",animationBegin:0,animationDuration:800,labelLine:!1,label:he,children:l.map((t,s)=>{var c;const h=((c=o[t.originalType])==null?void 0:c.light)||"#cccccc";return e.jsx(O,{fill:h},`cell-${s}`)})}),e.jsx(ie,{content:e.jsx(X,{})})]})})})})]}),e.jsxs(B,{className:"animate-slide-in-right bg-gradient-card hover:shadow-custom-hover transition-all duration-300",children:[e.jsxs(K,{children:[e.jsxs(F,{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-5 w-5 text-success animate-float"}),"Revenue by Site Type"]}),e.jsx(V,{children:"Total revenue for each site configuration"})]}),e.jsx(J,{className:"px-2",children:e.jsx(P,{config:g,children:e.jsx($,{width:"100%",height:300,children:e.jsxs(D,{data:l.map(t=>({type:t.name,revenue:t.value,originalType:t.originalType})),layout:"vertical",margin:{left:10,right:80,top:10,bottom:10},children:[e.jsx(Q,{strokeDasharray:"3 3"}),e.jsx(ee,{type:"number",tickFormatter:t=>`${t/1e3}K`}),e.jsx(te,{type:"category",dataKey:"type",width:120}),e.jsx(M,{content:e.jsx(R,{formatter:(t,s)=>[I(t),s]})}),e.jsx(G,{}),e.jsx(re,{dataKey:"revenue",radius:[4,4,0,0],animationBegin:0,animationDuration:800,label:{position:"right",formatter:t=>I(t)},children:l.map((t,s)=>{var c;const h=((c=o[t.originalType])==null?void 0:c.light)||"#cccccc";return e.jsx(O,{fill:h},`cell-${s}`)})})]})})})})]})]})]})}const Z=new Date().getFullYear(),fe=Array.from({length:5},(n,r)=>Z-r),Y=Array.from({length:12},(n,r)=>({value:r+1,name:new Date(0,r).toLocaleString("default",{month:"long"})}));function _e(){const[n,r]=v.useState([]),[d,l]=v.useState(!0),[o,g]=v.useState(null),[t,s]=v.useState("All"),[h,c]=v.useState(new Date().getMonth()+1),[j,p]=v.useState(Z);v.useEffect(()=>{(async()=>{try{l(!0);const[f,x]=await Promise.all([se(),ne(h,j)]),i=new Map(x.map(b=>[b.siteId,b])),_=f.map(b=>{const a=i.get(b.id);return{id:b.id,name:b.name,type:b.type,safaricomIncome:(a==null?void 0:a.earningsSafaricom)??0,airtelIncome:(a==null?void 0:a.earningsAirtel)??0,jtlIncome:(a==null?void 0:a.earningsJtl)??0,gridConsumption:(a==null?void 0:a.gridConsumption)??0,fuelConsumption:(a==null?void 0:a.fuelConsumption)??0,solarContribution:parseFloat((a==null?void 0:a.solarContribution)??"0"),gridCostPerKwh:(a==null?void 0:a.gridUnitCost)??0,fuelCostPerLiter:(a==null?void 0:a.fuelUnitCost)??0,solarMaintenanceCost:(a==null?void 0:a.solarMaintenanceCost)??0}});r(_),g(null)}catch(f){g("Failed to fetch revenue data. Please try again later."),console.error(f)}finally{l(!1)}})()},[h,j]);const m=v.useMemo(()=>n.filter(u=>{const f=u.safaricomIncome>0,x=u.airtelIncome>0,i=u.jtlIncome>0,_=[f,x,i].filter(Boolean).length;return t==="All"?!0:t==="Single-Operator"&&_===1?f&&!x&&!i||!f&&x&&!i||!f&&!x&&i:t==="Colocated"&&_===2?f&&x&&!i||f&&!x&&i||!f&&x&&i:t==="Multi-Vendor"&&_===3?f&&x&&i:!1}),[n,t]),y=u=>{var f;return((f=Y.find(x=>x.value===u))==null?void 0:f.name)||""};return d?e.jsxs("p",{children:["Loading revenue data for ",y(h)," ",j,"..."]}):o?e.jsx("p",{className:"text-destructive",children:o}):e.jsxs("div",{className:"flex-1 space-y-4 p-4 md:p-8 pt-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between space-y-2 md:space-y-0",children:[e.jsx("h2",{className:"text-3xl font-bold tracking-tight",children:"Revenue Breakdown"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(k,{value:String(h),onValueChange:u=>c(Number(u)),children:[e.jsx(L,{className:"w-[180px]",children:e.jsx(T,{placeholder:"Select Month"})}),e.jsx(A,{children:Y.map(u=>e.jsx(w,{value:String(u.value),children:u.name},u.value))})]}),e.jsxs(k,{value:String(j),onValueChange:u=>p(Number(u)),children:[e.jsx(L,{className:"w-[120px]",children:e.jsx(T,{placeholder:"Select Year"})}),e.jsx(A,{children:fe.map(u=>e.jsx(w,{value:String(u),children:u},u))})]}),e.jsxs(k,{onValueChange:s,defaultValue:"All",children:[e.jsx(L,{className:"w-[200px]",children:e.jsx(T,{placeholder:"Filter by site type"})}),e.jsxs(A,{children:[e.jsx(w,{value:"All",children:"All Sites"}),e.jsx(w,{value:"Single-Operator",children:"Single-Operator Sites"}),e.jsx(w,{value:"Colocated",children:"Colocated Sites"}),e.jsx(w,{value:"Multi-Vendor",children:"Multi-Vendor Sites"})]})]})]})]}),e.jsx(me,{sites:m})]})}export{_e as default};
